<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…</title>
    <style>
      body {
        font-family: "Tajawal", Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        direction: rtl;
      }
      h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 20px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      .filter-section {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        width: 200px;
        background: #f9f9f9;
      }
      .logout-btn {
        background: #e74c3c;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      .download-btn,
      .bulk-delete-btn {
        background: #27ae60;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 20px;
        display: inline-block;
      }
      .bulk-delete-btn {
        background: #e74c3c;
        margin-right: 10px;
      }
      .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
      }
      .results-table th,
      .results-table td {
        padding: 5px;
        text-align: center;
        border-bottom: 1px solid #ddd;
        white-space: nowrap;
      }
      #resultsTable tbody tr:hover {
        background-color: #dd8760; /* Ù„ÙˆÙ† ÙØ§ØªØ­ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± */
        cursor: pointer; /* ÙŠØ¨ÙŠÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù†Ù‡ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙØ§Ø¹Ù„ */
        transition: background-color 0.2s ease-in-out;
      }

      .results-table th {
        background: #3498db;
        color: white;
      }
      .results-table tr:nth-child(even) {
        background: #f9f9f9;
      }
      .delete-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 5px;
        cursor: pointer;
      }
      .delete-btn:hover {
        background: #c0392b;
      }
      .no-results {
        text-align: center;
        color: #7f8c8d;
        font-size: 18px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…</h1>
      <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

      <div class="filter-section">
        <select id="testNameFilter" onchange="filterResults()">
          <option value="">ÙƒÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</option>
        </select>
        <select id="classFilter" onchange="filterResults()">
          <option value="">ÙƒÙ„ Ø§Ù„Ø´Ø¹Ø¨</option>
        </select>
        <select id="studentClassFilter" onchange="filterResults()">
          <option value="">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option>
        </select>
      </div>

      <table class="results-table" id="resultsTable">
        <colgroup>
          <col style="width: 5%" />
          <!-- checkbox -->
          <col style="width: 18%" />
          <!-- Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ -->
          <col style="width: 13%" />
          <!-- Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
          <col style="width: 10%" />
          <!-- Ø§Ù„Ø´Ø¹Ø¨Ø© -->
          <col style="width: 10%" />
          <!-- Ø§Ù„ØµÙ -->
          <col style="width: 10%" />
          <!-- Ø§Ù„Ø¹Ù„Ø§Ù…Ø© -->
          <col style="width: 12%" />
          <!-- Ø§Ù„ØªØ§Ø±ÙŠØ® -->
          <col style="width: 12%" />
          <!-- Ø§Ù„ÙˆÙ‚Øª -->
          <col style="width: 10%" />
          <!-- Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
        </colgroup>
        <thead>
          <tr>
            <th>
              <input
                type="checkbox"
                id="selectAll"
                onclick="toggleSelectAll(this)"
              />
            </th>
            <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
            <th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
            <th>Ø§Ù„ØµÙ</th>
            <th>Ø§Ù„Ø¹Ù„Ø§Ù…Ø©</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>

      <div id="noResults" class="no-results" style="display: none">
        Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©
      </div>

      <button class="bulk-delete-btn" onclick="deleteSelected()">
        ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯
      </button>
      <button class="download-btn" onclick="downloadExcel()">
        ØªÙ†Ø²ÙŠÙ„ ÙƒÙ€ Excel
      </button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAiJVhRbPOR0ty2Zaoyu4FQj9U4_rpnCf8",
        authDomain: "examsy-21dc3.firebaseapp.com",
        projectId: "examsy-21dc3",
        storageBucket: "examsy-21dc3.firebasestorage.app",
        messagingSenderId: "357464025229",
        appId: "1:357464025229:web:b920c8290f985f54339ac4",
        measurementId: "G-CWZ7MR4V26",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      let allResults = [];
      let testNames = new Set();
      let classes = new Set();
      let studentClasses = new Set();
      let filteredResults = [];

      function fetchExamResults() {
        db.collection("examResults")
          .orderBy("timestamp", "desc")
          .get()
          .then((querySnapshot) => {
            allResults = [];
            testNames.clear();
            classes.clear();
            studentClasses.clear();

            querySnapshot.forEach((doc) => {
              const data = doc.data();
              data.id = doc.id;
              data.studentClass = data.testName
                ? data.testName.split("-")[0]
                : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
              allResults.push(data);

              if (data.testName) testNames.add(data.testName);
              if (data.class) classes.add(data.class);
              studentClasses.add(data.studentClass);
            });

            populateFilters();
            filteredResults = allResults;
            displayResults(filteredResults);
          })
          .catch((error) => {
            console.error("Error fetching:", error);
          });
      }

      function populateFilters() {
        const testNameFilter = document.getElementById("testNameFilter");
        const classFilter = document.getElementById("classFilter");
        const studentClassFilter =
          document.getElementById("studentClassFilter");

        testNameFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</option>';
        classFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø´Ø¹Ø¨</option>';
        studentClassFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option>';

        testNames.forEach((t) => {
          let o = document.createElement("option");
          o.value = t;
          o.textContent = t;
          testNameFilter.appendChild(o);
        });
        classes.forEach((c) => {
          let o = document.createElement("option");
          o.value = c;
          o.textContent = c;
          classFilter.appendChild(o);
        });
        studentClasses.forEach((sc) => {
          let o = document.createElement("option");
          o.value = sc;
          o.textContent = sc;
          studentClassFilter.appendChild(o);
        });
      }

      function filterResults() {
        const t = document.getElementById("testNameFilter").value;
        const c = document.getElementById("classFilter").value;
        const sc = document.getElementById("studentClassFilter").value;

        filteredResults = allResults.filter((r) => {
          return (
            (t ? r.testName === t : true) &&
            (c ? r.class === c : true) &&
            (sc ? r.studentClass === sc : true)
          );
        });

        displayResults(filteredResults);
      }

      function displayResults(results) {
        const body = document.getElementById("resultsBody");
        const noRes = document.getElementById("noResults");
        body.innerHTML = "";

        if (results.length === 0) {
          noRes.style.display = "block";
          return;
        }
        noRes.style.display = "none";

        results.forEach((r) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><input type="checkbox" class="rowCheckbox" data-id="${
              r.id
            }"></td>
            <td>${r.name || ""}</td>
            <td>${r.testName || ""}</td>
            <td>${r.class || ""}</td>
            <td>${r.studentClass || ""}</td>
            <td>${r.score || ""}</td>
            <td>${r.date || ""}</td>
            <td>${r.time || ""}</td>
            <td><button class="delete-btn" onclick="deleteResult('${
              r.id
            }')">ğŸ—‘</button></td>
        `;
          // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙØŒ Ø­Ø¯Ø¯ Ø£Ùˆ Ø£Ù„Øº ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù€ checkbox
          row.addEventListener("click", function (e) {
            if (e.target.tagName !== "INPUT" && e.target.tagName !== "BUTTON") {
              const checkbox = this.querySelector(".rowCheckbox");
              checkbox.checked = !checkbox.checked;
            }
          });
          body.appendChild(row);
        });
      }

      function toggleSelectAll(master) {
        document
          .querySelectorAll(".rowCheckbox")
          .forEach((cb) => (cb.checked = master.checked));
      }

      function deleteResult(id) {
        if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;
        db.collection("examResults")
          .doc(id)
          .delete()
          .then(() => {
            allResults = allResults.filter((r) => r.id !== id);
            filteredResults = filteredResults.filter((r) => r.id !== id);
            displayResults(filteredResults);
          })
          .catch((err) => console.error("Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­Ø°Ù:", err));
      }

      function deleteSelected() {
        const selected = Array.from(
          document.querySelectorAll(".rowCheckbox:checked")
        ).map((cb) => cb.dataset.id);
        if (selected.length === 0) {
          alert("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ ØµÙÙˆÙ!");
          return;
        }
        if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŸ")) return;

        const promises = selected.map((id) =>
          db.collection("examResults").doc(id).delete()
        );
        Promise.all(promises)
          .then(() => {
            allResults = allResults.filter((r) => !selected.includes(r.id));
            filteredResults = filteredResults.filter(
              (r) => !selected.includes(r.id)
            );
            displayResults(filteredResults);
          })
          .catch((err) => console.error("Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªØ¹Ø¯Ø¯:", err));
      }

      function downloadExcel() {
        if (filteredResults.length === 0) {
          alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ†Ø²ÙŠÙ„!");
          return;
        }
        const data = filteredResults.map((r) => ({
          "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨": r.name || "",
          "Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±": r.testName || "",
          Ø§Ù„Ø´Ø¹Ø¨Ø©: r.class || "",
          Ø§Ù„ØµÙ: r.studentClass || "",
          Ø§Ù„Ø¹Ù„Ø§Ù…Ø©: r.score || "",
          Ø§Ù„ØªØ§Ø±ÙŠØ®: r.date || "",
          Ø§Ù„ÙˆÙ‚Øª: r.time || "",
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Exam Results");
        XLSX.writeFile(wb, "exam_results.xlsx");
      }

      function logout() {
        window.location.href = "index.html";
      }

      fetchExamResults();
    </script>
  </body>
</html>
