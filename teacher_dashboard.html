<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>لوحة تحكم المعلم</title>
    <style>
      body {
        font-family: "Tajawal", Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        direction: rtl;
      }
      h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 20px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      .filter-section {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        width: 200px;
        background: #f9f9f9;
      }
      .logout-btn {
        background: #e74c3c;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      .download-btn,
      .bulk-delete-btn {
        background: #27ae60;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 20px;
        display: inline-block;
      }
      .bulk-delete-btn {
        background: #e74c3c;
        margin-right: 10px;
      }
      .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
      }
      .results-table th,
      .results-table td {
        padding: 5px;
        text-align: center;
        border-bottom: 1px solid #ddd;
        white-space: nowrap;
      }
      #resultsTable tbody tr:hover {
        background-color: #dd8760; /* لون فاتح عند المرور */
        cursor: pointer; /* يبين للمستخدم انه قابل للتفاعل */
        transition: background-color 0.2s ease-in-out;
      }

      .results-table th {
        background: #3498db;
        color: white;
      }
      .results-table tr:nth-child(even) {
        background: #f9f9f9;
      }
      .delete-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 5px;
        cursor: pointer;
      }
      .delete-btn:hover {
        background: #c0392b;
      }
      .no-results {
        text-align: center;
        color: #7f8c8d;
        font-size: 18px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>لوحة تحكم المعلم</h1>
      <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>

      <div class="filter-section">
        <select id="testNameFilter" onchange="filterResults()">
          <option value="">كل الاختبارات</option>
        </select>
        <select id="classFilter" onchange="filterResults()">
          <option value="">كل الشعب</option>
        </select>
        <select id="studentClassFilter" onchange="filterResults()">
          <option value="">كل الصفوف</option>
        </select>
      </div>

      <table class="results-table" id="resultsTable">
        <colgroup>
          <col style="width: 5%" />
          <!-- checkbox -->
          <col style="width: 18%" />
          <!-- اسم الطالب -->
          <col style="width: 13%" />
          <!-- اسم الاختبار -->
          <col style="width: 10%" />
          <!-- الشعبة -->
          <col style="width: 10%" />
          <!-- الصف -->
          <col style="width: 10%" />
          <!-- العلامة -->
          <col style="width: 12%" />
          <!-- التاريخ -->
          <col style="width: 12%" />
          <!-- الوقت -->
          <col style="width: 10%" />
          <!-- إجراءات -->
        </colgroup>
        <thead>
          <tr>
            <th>
              <input
                type="checkbox"
                id="selectAll"
                onclick="toggleSelectAll(this)"
              />
            </th>
            <th>اسم الطالب</th>
            <th>اسم الاختبار</th>
            <th>الشعبة</th>
            <th>الصف</th>
            <th>العلامة</th>
            <th>التاريخ</th>
            <th>الوقت</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>

      <div id="noResults" class="no-results" style="display: none">
        لا توجد نتائج مطابقة
      </div>

      <button class="bulk-delete-btn" onclick="deleteSelected()">
        🗑 حذف المحدد
      </button>
      <button class="download-btn" onclick="downloadExcel()">
        تنزيل كـ Excel
      </button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAiJVhRbPOR0ty2Zaoyu4FQj9U4_rpnCf8",
        authDomain: "examsy-21dc3.firebaseapp.com",
        projectId: "examsy-21dc3",
        storageBucket: "examsy-21dc3.firebasestorage.app",
        messagingSenderId: "357464025229",
        appId: "1:357464025229:web:b920c8290f985f54339ac4",
        measurementId: "G-CWZ7MR4V26",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      let allResults = [];
      let testNames = new Set();
      let classes = new Set();
      let studentClasses = new Set();
      let filteredResults = [];

      function fetchExamResults() {
        db.collection("examResults")
          .orderBy("timestamp", "desc")
          .get()
          .then((querySnapshot) => {
            allResults = [];
            testNames.clear();
            classes.clear();
            studentClasses.clear();

            querySnapshot.forEach((doc) => {
              const data = doc.data();
              data.id = doc.id;
              data.studentClass = data.testName
                ? data.testName.split("-")[0]
                : "غير معروف";
              allResults.push(data);

              if (data.testName) testNames.add(data.testName);
              if (data.class) classes.add(data.class);
              studentClasses.add(data.studentClass);
            });

            populateFilters();
            filteredResults = allResults;
            displayResults(filteredResults);
          })
          .catch((error) => {
            console.error("Error fetching:", error);
          });
      }

      function populateFilters() {
        const testNameFilter = document.getElementById("testNameFilter");
        const classFilter = document.getElementById("classFilter");
        const studentClassFilter =
          document.getElementById("studentClassFilter");

        testNameFilter.innerHTML = '<option value="">كل الاختبارات</option>';
        classFilter.innerHTML = '<option value="">كل الشعب</option>';
        studentClassFilter.innerHTML = '<option value="">كل الصفوف</option>';

        testNames.forEach((t) => {
          let o = document.createElement("option");
          o.value = t;
          o.textContent = t;
          testNameFilter.appendChild(o);
        });
        classes.forEach((c) => {
          let o = document.createElement("option");
          o.value = c;
          o.textContent = c;
          classFilter.appendChild(o);
        });
        studentClasses.forEach((sc) => {
          let o = document.createElement("option");
          o.value = sc;
          o.textContent = sc;
          studentClassFilter.appendChild(o);
        });
      }

      function filterResults() {
        const t = document.getElementById("testNameFilter").value;
        const c = document.getElementById("classFilter").value;
        const sc = document.getElementById("studentClassFilter").value;

        filteredResults = allResults.filter((r) => {
          return (
            (t ? r.testName === t : true) &&
            (c ? r.class === c : true) &&
            (sc ? r.studentClass === sc : true)
          );
        });

        displayResults(filteredResults);
      }

      function displayResults(results) {
        const body = document.getElementById("resultsBody");
        const noRes = document.getElementById("noResults");
        body.innerHTML = "";

        if (results.length === 0) {
          noRes.style.display = "block";
          return;
        }
        noRes.style.display = "none";

        results.forEach((r) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><input type="checkbox" class="rowCheckbox" data-id="${
              r.id
            }"></td>
            <td>${r.name || ""}</td>
            <td>${r.testName || ""}</td>
            <td>${r.class || ""}</td>
            <td>${r.studentClass || ""}</td>
            <td>${r.score || ""}</td>
            <td>${r.date || ""}</td>
            <td>${r.time || ""}</td>
            <td><button class="delete-btn" onclick="deleteResult('${
              r.id
            }')">🗑</button></td>
        `;
          // عند النقر على الصف، حدد أو ألغ تحديد الـ checkbox
          row.addEventListener("click", function (e) {
            if (e.target.tagName !== "INPUT" && e.target.tagName !== "BUTTON") {
              const checkbox = this.querySelector(".rowCheckbox");
              checkbox.checked = !checkbox.checked;
            }
          });
          body.appendChild(row);
        });
      }

      function toggleSelectAll(master) {
        document
          .querySelectorAll(".rowCheckbox")
          .forEach((cb) => (cb.checked = master.checked));
      }

      function deleteResult(id) {
        if (!confirm("هل أنت متأكد من الحذف؟")) return;
        db.collection("examResults")
          .doc(id)
          .delete()
          .then(() => {
            allResults = allResults.filter((r) => r.id !== id);
            filteredResults = filteredResults.filter((r) => r.id !== id);
            displayResults(filteredResults);
          })
          .catch((err) => console.error("خطأ بالحذف:", err));
      }

      function deleteSelected() {
        const selected = Array.from(
          document.querySelectorAll(".rowCheckbox:checked")
        ).map((cb) => cb.dataset.id);
        if (selected.length === 0) {
          alert("لم يتم تحديد أي صفوف!");
          return;
        }
        if (!confirm("هل تريد حذف العناصر المحددة؟")) return;

        const promises = selected.map((id) =>
          db.collection("examResults").doc(id).delete()
        );
        Promise.all(promises)
          .then(() => {
            allResults = allResults.filter((r) => !selected.includes(r.id));
            filteredResults = filteredResults.filter(
              (r) => !selected.includes(r.id)
            );
            displayResults(filteredResults);
          })
          .catch((err) => console.error("خطأ بالحذف المتعدد:", err));
      }

      function downloadExcel() {
        if (filteredResults.length === 0) {
          alert("لا توجد بيانات للتنزيل!");
          return;
        }
        const data = filteredResults.map((r) => ({
          "اسم الطالب": r.name || "",
          "اسم الاختبار": r.testName || "",
          الشعبة: r.class || "",
          الصف: r.studentClass || "",
          العلامة: r.score || "",
          التاريخ: r.date || "",
          الوقت: r.time || "",
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Exam Results");
        XLSX.writeFile(wb, "exam_results.xlsx");
      }

      function logout() {
        window.location.href = "index.html";
      }

      fetchExamResults();
    </script>
  </body>
</html>
