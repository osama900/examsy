<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</title>
  <link rel="stylesheet" href="css/style.css" />
  <script>
    if (!localStorage.getItem("std_id")) {
      alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
      window.location.href = "std_login.html";
    }
  </script>
  <style>
    .class-badge {
      position: absolute;
      top: 0;
      left: 0;
      background: #e3342f;
      color: #fff;
      font-size: 0.75rem;
      font-weight: bold;
      padding: 0.25rem 0.75rem;
      border-top-left-radius: 0.5rem;
      border-bottom-right-radius: 0.5rem;
    }



    /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† */
    #teacher-card {
      position: relative;
      background: #f6f7f8;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease-in-out;
    }

    #teacher-card:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
      transform: translateY(-4px);
    }



    #teacher-icon {
      width: 64px;
      height: 64px;
      fill: #137fec;
    }

    #teacher-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    #teacher-desc {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 1.5rem;
    }



    /* User Profile Styles */
    .user-class {
      font-size: 0.75rem;
      color: #666;
      font-weight: bold;
      margin-top: 2px;
    }

    /* Profile Dropdown Styles */
    .profile-wrapper {
      position: relative;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: rgba(255, 255, 255, 0.9);
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }

    .user-profile:hover {
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .profile-dropdown {
      position: absolute;
      top: calc(100% + 10px);
      left: 0;
      background: white;
      min-width: 160px;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 1000;
      overflow: hidden;
      border: 1px solid #f0f0f0;
    }

    .profile-dropdown.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      color: #e74c3c;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s ease;
      direction: rtl;
    }

    .dropdown-item:hover {
      background: #fff5f5;
    }

    .dropdown-item svg {
      color: #e74c3c;
    }

    .user-initials-badge {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #137fec, #6fbafe);
      color: #fff;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 1rem;
      border: 2px solid #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .user-coins-display {
      display: flex;
      align-items: center;
      gap: 5px;
      background: rgba(243, 156, 18, 0.1);
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid rgba(243, 156, 18, 0.3);
      color: #d35400;
      font-weight: bold;
      font-size: 0.9rem;
      margin-right: 10px;
      transition: all 0.3s ease;
    }

    .user-coins-display:hover {
      background: rgba(243, 156, 18, 0.2);
      transform: scale(1.05);
    }

    .profile-wrapper {
      display: flex;
      align-items: center;
    }

    /* Notification Styles */
    .notif-wrapper {
      position: relative;
      margin-left: 15px;
      cursor: pointer;
    }

    .notif-bell {
      font-size: 24px;
      color: #7f8c8d;
      transition: color 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #f0f2f5;
    }

    .notif-bell:hover {
      background: #e1e4e8;
      color: #2c3e50;
    }

    .notif-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #e74c3c;
      color: white;
      border-radius: 50%;
      min-width: 18px;
      height: 18px;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      font-weight: bold;
      opacity: 0;
      transform: scale(0);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .notif-badge.show {
      opacity: 1;
      transform: scale(1);
    }

    .notif-dropdown {
      position: absolute;
      top: 120%;
      left: 0;
      /* Align left for RTL context in header usually means right, but let's check direction */
      /* Since dir is likely RTL or handled by styles, we need to be careful. 
         In the header flex, the profile is on the left? No, let's look at the header structure.
         Header: Logo (Right usually in RTL) ... Profile (Left usually).
         If profile is on the left, we want the dropdown to align to the left.
      */

      width: 300px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      border: 1px solid #f0f0f0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 2000;
      overflow: hidden;
    }

    /* Adjust alignment based on parent being relative */
    /* If the bell is near the left edge, we might need left: 0 or right: auto */

    .notif-dropdown.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .notif-header {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fafafa;
    }

    .notif-header h3 {
      margin: 0;
      font-size: 14px;
      color: #333;
    }

    .notif-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .notif-item {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      transition: background 0.2s;
    }

    .notif-item:last-child {
      border-bottom: none;
    }

    .notif-item:hover {
      background: #f9f9f9;
    }

    .notif-item.unread {
      background: #ebf5fb;
    }

    .notif-title {
      font-weight: bold;
      font-size: 13px;
      color: #2c3e50;
      margin-bottom: 4px;
      display: block;
    }

    .notif-body {
      font-size: 12px;
      color: #555;
      line-height: 1.4;
      display: block;
    }

    .notif-time {
      font-size: 10px;
      color: #95a5a6;
      display: block;
      margin-top: 5px;
      text-align: left;
    }

    .empty-notif {
      padding: 20px;
      text-align: center;
      color: #999;
      font-size: 13px;
    }

    /* Dashboard Styles */
    .dashboard-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 20px;
    }

    .stat-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: 1.25rem;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      width: 56px;
      height: 56px;
      background: rgba(19, 127, 236, 0.1);
      border-radius: 0.75rem;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #137fec;
    }

    .stat-info {
      display: flex;
      flex-direction: column;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 800;
      color: #2c3e50;
      line-height: 1.2;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #7f8c8d;
      font-weight: 500;
    }

    /* Unit Progress Styles */
    .unit-progress-card {
      grid-column: 1 / -1;
      background: white;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      margin-top: 1rem;
    }

    .unit-progress-header {
      display: flex;
      flex-direction: row;
      /* Icon first, then text */
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f8f9fa;
      direction: rtl;
    }

    .unit-progress-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #2c3e50;
    }

    .lessons-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      direction: rtl;
      /* Lessons start from the right */
    }

    .lesson-item {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      /* Standard spacing between icon and text */
      padding: 0.75rem 1rem;
      background: #ffffff;
      border-radius: 0.75rem;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      /* Slightly stronger shadow as requested */
      border: 1px solid #f1f3f5;
      direction: rtl;
    }

    .lesson-item:hover {
      background: #fdfdfd;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .lesson-name {
      font-size: 0.95rem;
      color: #34495e;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-grow: 1;
      text-align: right;
    }

    .lesson-item.locked {
      opacity: 0.6;
      background: #f1f3f5;
      cursor: not-allowed;
      pointer-events: none;
      box-shadow: none;
      border: 1px dashed #dee2e6;
    }

    .status-badge {
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lesson-item.locked:hover {
      transform: none;
      box-shadow: none;
    }

    .lesson-item.locked .lesson-name {
      color: #95a5a6;
    }

    .lesson-item.locked .status-badge {
      filter: grayscale(1);
      opacity: 0.5;
    }

    .percentage-circle {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 1rem auto;
    }

    .percentage-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      font-weight: 800;
      color: #2c3e50;
    }

    .stat-card.progress-card {
      background: linear-gradient(135deg, #ffffff, #f0f7ff);
      border-right: 4px solid #3498db;
    }
  </style>
</head>

<body>
  <header class="main-header">
    <div class="header-content"
      style="display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1200px; margin: 0 auto;">
      <a href="index.html" class="logo-link">
        <span class="logo-emoji">ğŸ“š</span>
        <span class="logo-text">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</span>
      </a>
      <div id="user-profile-container" style="display: flex; align-items: center;">
        <!-- Notifications -->
        <div class="notif-wrapper" id="notifWrapper">
          <div class="notif-bell" onclick="toggleNotifications()">
            ğŸ””
            <span class="notif-badge" id="notifBadge">0</span>
          </div>
          <div class="notif-dropdown" id="notifDropdown">
            <div class="notif-header">
              <h3>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
            </div>
            <div class="notif-list" id="notifList">
              <div class="empty-notif">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <header class="hero">
    <h1 style="margin:2px; padding: 2px;">ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ </h1>
    <p style="font-size: 35px;" id="hero-student-info"></p>
    <p> ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© </p>
    <p>Ù…Ø¯Ø±Ø³Ø© Ø²ÙŠØ¯ Ø¨Ù† Ø­Ø§Ø±Ø«Ø© Ø§Ù„Ø§Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø¨Ù†ÙŠÙ†</p>
  </header>

  <div class="dashboard-container">
    <div class="stat-cards-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ ÙˆÙ‚Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</span>
          <span class="stat-value" id="totalStudyTime">0:00</span>
        </div>
      </div>
      <div class="stat-card" style="border-right: 4px solid #f1c40f;">
        <div class="stat-icon" style="background: rgba(241, 196, 15, 0.1); color: #f1c40f;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
            <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
            <path d="M4 22h16"></path>
            <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
            <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
            <path d="M18 2H6v7a6 6 0 0 0 12 0V2z"></path>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-label">ØªØ±ØªÙŠØ¨Ùƒ Ø¨ÙŠÙ† Ø·Ù„Ø§Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø©</span>
          <span class="stat-value" id="studentRank">--</span>
        </div>
      </div>
      <div class="stat-card progress-card">
        <div class="stat-icon" style="background: rgba(52, 152, 219, 0.1); color: #3498db;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-label">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</span>
          <span class="stat-value" id="completionPercentage">0%</span>
        </div>
      </div>

      <div class="stat-card" style="border-right: 4px solid #f39c12;">
        <div class="stat-icon" style="background: rgba(243, 156, 18, 0.1); color: #f39c12;">
          <span style="font-size: 24px;">ğŸª™</span>
        </div>
        <div class="stat-info" style="flex-direction: row; align-items: center; gap: 10px;">
          <div style="display: flex; flex-direction: column;">
            <span class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· </span>
            <span class="stat-value" id="user-coins-count">0</span>
          </div>
        </div>
      </div>

      <div class="stat-card" style="border-right: 4px solid #9b59b6;">
        <div class="stat-icon" style="background: rgba(155, 89, 182, 0.1); color: #9b59b6;">
          <span style="font-size: 24px;">ğŸ””</span>
        </div>
        <div class="stat-info">
          <span class="stat-label">ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
          <span class="stat-value" id="lastNotifText"
            style="font-size: 0.9rem; font-weight: 500; color: #555; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4;">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
          </span>
        </div>
      </div>

      <div class="unit-progress-card" id="unit3Card" style="display: none;">
        <div class="unit-progress-header">
          <div class="stat-icon"
            style="width: 40px; height: 40px; background: rgba(155, 89, 182, 0.1); color: #9b59b6;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
          </div>
          <span class="unit-progress-title">ØªÙ‚Ø¯Ù… Ø¯Ø±ÙˆØ³ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©</span>
        </div>
        <div class="lessons-list" id="unit3LessonsList"></div>
      </div>

      <div class="unit-progress-card" id="unit4Card" style="display: none;">
        <div class="unit-progress-header">
          <div class="stat-icon"
            style="width: 40px; height: 40px; background: rgba(230, 126, 34, 0.1); color: #e67e22;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
              <polyline points="2 17 12 22 22 17"></polyline>
              <polyline points="2 12 12 17 22 12"></polyline>
            </svg>
          </div>
          <span class="unit-progress-title">ØªÙ‚Ø¯Ù… Ø¯Ø±ÙˆØ³ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©</span>
        </div>
        <div class="lessons-list" id="unit4LessonsList"></div>
      </div>
    </div>
  </div>


  <footer>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© Teacher Osama Omar</footer>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    // Firebase Configuration (Same as others)
    const firebaseConfig = {
      apiKey: "AIzaSyAiJVhRbPOR0ty2Zaoyu4FQj9U4_rpnCf8",
      authDomain: "examsy-21dc3.firebaseapp.com",
      projectId: "examsy-21dc3",
      storageBucket: "examsy-21dc3.firebasestorage.app",
      messagingSenderId: "357464025229",
      appId: "1:357464025229:web:b920c8290f985f54339ac4",
      measurementId: "G-CWZ7MR4V26",
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    async function loadDashboardStats() {
      const stdId = localStorage.getItem('std_id');
      if (!stdId) return;

      try {
        const snapshot = await db.collection('std_id').doc(stdId).collection('study_activity').get();
        let totalSeconds = 0;

        snapshot.forEach(doc => {
          totalSeconds += doc.data().sessionTimeSeconds || 0;
        });

        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);

        // Format as H:MM
        const formattedTime = `${hours}:${minutes.toString().padStart(2, '0')}`;
        document.getElementById('totalStudyTime').textContent = formattedTime;

        // Update student's total time in Firestore for ranking
        await db.collection('std_id').doc(stdId).set({
          totalStudyTimeSeconds: totalSeconds,
          lastDashboardUpdate: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // Calculate Rank within the same Class and Grade
        const stdGrade = localStorage.getItem('std_grade');
        const stdClass = localStorage.getItem('std_class');

        const classSnapshot = await db.collection('std_id')
          .where('std_grade', '==', stdGrade)
          .where('std_class', '==', stdClass)
          .get();

        const studentsInClass = [];
        classSnapshot.forEach(doc => {
          const data = doc.data();
          studentsInClass.push({
            id: doc.id,
            time: data.totalStudyTimeSeconds || 0
          });
        });

        // Sort students by time (descending)
        studentsInClass.sort((a, b) => b.time - a.time);

        let rank = 0;
        const totalCompetitors = studentsInClass.length;

        for (let i = 0; i < studentsInClass.length; i++) {
          if (studentsInClass[i].id === stdId) {
            rank = i + 1;
            break;
          }
        }

        if (rank > 0) {
          const ordinals = {
            1: 'Ø§Ù„Ø£ÙˆÙ„', 2: 'Ø§Ù„Ø«Ø§Ù†ÙŠ', 3: 'Ø§Ù„Ø«Ø§Ù„Ø«', 4: 'Ø§Ù„Ø±Ø§Ø¨Ø¹', 5: 'Ø§Ù„Ø®Ø§Ù…Ø³',
            6: 'Ø§Ù„Ø³Ø§Ø¯Ø³', 7: 'Ø§Ù„Ø³Ø§Ø¨Ø¹', 8: 'Ø§Ù„Ø«Ø§Ù…Ù†', 9: 'Ø§Ù„ØªØ§Ø³Ø¹', 10: 'Ø§Ù„Ø¹Ø§Ø´Ø±'
          };
          const ordinalText = ordinals[rank] ? ` ( ${ordinals[rank]} )` : '';
          document.getElementById('studentRank').textContent = `${rank} / ${totalCompetitors}${ordinalText}`;
        }

      } catch (error) {
        console.error("Error loading dashboard stats:", error);
      }
    }

    async function updateDashboardNotificationCard() {
      const stdId = localStorage.getItem('std_id');
      const textElem = document.getElementById('lastNotifText');
      if (!stdId) {
        textElem.textContent = "ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        return;
      }

      try {
        // Fetch without orderBy to avoid composite index requirements
        // Get 10 most recent (best effort without index)
        const [globalNotifs, personalNotifs] = await Promise.all([
          db.collection('notifications')
            .where('target', '==', 'all')
            .limit(10)
            .get(),
          db.collection('notifications')
            .where('target', '==', stdId)
            .limit(10)
            .get()
        ]);

        let allDocs = [];
        globalNotifs.forEach(doc => allDocs.push(doc.data()));
        personalNotifs.forEach(doc => allDocs.push(doc.data()));

        // Sort client-side
        allDocs.sort((a, b) => {
          const t1 = a.timestamp ? a.timestamp.seconds : 0;
          const t2 = b.timestamp ? b.timestamp.seconds : 0;
          return t2 - t1; // Descending
        });

        const latest = allDocs.length > 0 ? allDocs[0] : null;

        if (latest) {
          textElem.textContent = `${latest.title}: ${latest.body}`;
          textElem.style.color = "#2c3e50";
        } else {
          textElem.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
          textElem.style.color = "#95a5a6";
        }
      } catch (err) {
        console.error("Error fetching latest notification:", err);
        textElem.textContent = "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
      }
    }

    // Initialize Auth Listener
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        console.log("Auth State: User signed in", user.email);
        loadDashboardStats();
        loadAllUnitsProgress();
        updateDashboardNotificationCard();
      } else {
        console.log("Auth State: No user signed in");
      }
    });

    // document.addEventListener('DOMContentLoaded', ...) removed as it is replaced by Auth listener


    // Unit Progress Logic
    const CURRICULUM = {
      "7": {
        "3": [
          { id: "7-3-1", name: "Ø§Ù„Ù…ÙˆØ§Ø·Ù†Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©", path: "page/7th/3-1/7c.html" },
          { id: "7-3-2", name: "Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ø§Ù„ÙÙƒØ±ÙŠØ©", path: "page/7th/3-2/7c.html" },
          { id: "7-3-3", name: "Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", path: "page/7th/3-3/7c.html" },
          { id: "7-3-4", name: "Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªÙˆØ§Ø²Ù† Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©", path: "page/7th/3-4/7c.html" }
        ],
        "4": [
          { id: "7-4-1", name: "Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª", path: "page/7th/4-1/7c.html" },
          { id: "7-4-2", name: "ØªØµÙ…ÙŠÙ… Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª", path: "page/7th/4-2/7c.html" },
          { id: "7-4-3", name: "Ø·Ø±Ù‚ ØªÙ…Ø«ÙŠÙ„ Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª", path: "page/7th/4-3/7c.html" }
        ]
      },
      "8": {
        "3": [
          { id: "8-3-1", name: "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", path: "page/8th/3-1/8c.html" },
          { id: "8-3-2", name: "Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ù†ØªØ±Ù†Øª", path: "page/8th/3-2/8c.html" },
          { id: "8-3-3", name: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", path: "page/8th/3-3/8c.html" },
          { id: "8-3-4", name: "Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© ÙˆØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", path: "page/8th/3-4/8c.html" }
        ],
        "4": [
          { id: "8-4-1", name: "ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø´Ø¨ÙƒØ§Øª", path: "page/8th/4-1/8c.html" },
          { id: "8-4-2", name: "ØªÙ…Ø¯Ø¯ Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆÙ…ÙˆØ«ÙˆÙ‚ÙŠØªÙ‡Ø§", path: "page/8th/4-2/8c.html" },
          { id: "8-4-3", name: "Ø§Ø³Ø§Ø³ÙŠØ§Øª Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø´Ø¨ÙƒØ§Øª ", path: "page/8th/4-3/8c.html" },
          { id: "8-4-4", name: "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ø§Ùƒ ØªØ±ÙŠØ³Ø± Ù„Ù„Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©", path: "page/8th/4-4/8c.html" },
          { id: "8-4-5", name: "Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù†ØªØ±Ù†Øª Ø§Ù„Ø§Ø´ÙŠØ§Ø¡ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø§Ùƒ ØªØ±ÙŠØ³Ø±", path: "page/8th/4-5/8c.html" }
        ]
      },
      "9": {

        "3": [
          { id: "9-3-1", name: "Ø£Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ùˆ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", path: "page/9th/3-1/9c.html" },
          { id: "9-3-2", name: "ØªÙ‡Ø¯ÙŠØ¯Ø§Øª Ø§Ù„Ø§Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ", path: "page/9th/3-2/9c.html" },
          { id: "9-3-3", name: "Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø§Ù…Ù† Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª", path: "page/9th/3-3/9c.html" },
          { id: "9-3-4", name: "ÙˆØ³Ø§Ø¦Ù„ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", path: "page/9th/3-4/9c.html" },
          { id: "9-3-5", name: "Ø§Ù„ØªØ´ÙÙŠØ±", path: "page/9th/3-5/9c.html" }
        ],
        "4": [
          { id: "9-4-1", name: "Ù…Ù‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", path: "page/9th/4-1/9c.html" },
          { id: "9-4-2", name: "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", path: "page/9th/4-2/9c.html" },
          { id: "9-4-3", name: "Ø§Ù„Ø±ÙˆØ¨ÙˆØª", path: "page/9th/4-3/9c.html" },
          { id: "9-4-4", name: "Ø§Ø³Ø§Ø³ÙŠØ§Øª Ø¨Ø±Ù…Ø¬Ø© Ø±ÙˆØ¨ÙˆØª", path: "page/9th/4-4/9c.html" }
        ]
      }
    };

    async function loadAllUnitsProgress() {
      let stdEmail = localStorage.getItem('std_email');
      const stdGrade = localStorage.getItem('std_grade');
      const stdId = localStorage.getItem('std_id'); // Fallback ID

      // Fallback: If email is missing but ID exists (user didn't re-login), fetch email
      if (!stdEmail && stdId) {
        try {
          const userDoc = await db.collection('std_id').doc(stdId).get();
          if (userDoc.exists) {
            stdEmail = userDoc.data().std_email;
            if (stdEmail) localStorage.setItem('std_email', stdEmail); // Save for future
          }
        } catch (e) { console.error("Error fetching email fallback:", e); }
      }

      console.log("Debug Lessons: stdEmail =", stdEmail, "stdGrade =", stdGrade);

      if (!stdEmail || !CURRICULUM[stdGrade]) {
        console.warn("Debug Lessons: Missing stdEmail or curriculum for grade", stdGrade);
        return;
      }

      try {
        // Fetch user document by email
        const userQuery = await db.collection('std_id').where('std_email', '==', stdEmail).limit(1).get();

        if (userQuery.empty) {
          console.error("Debug Lessons: No student found with email", stdEmail);
          return;
        }

        const userDoc = userQuery.docs[0];
        const userId = userDoc.id; // Correct Document ID from query

        // Fetch user activities using the correct Document ID
        const snapshot = await userDoc.ref.collection('study_activity').get();
        const activityMap = {};
        snapshot.forEach(doc => activityMap[doc.id] = doc.data());

        // Fetch global visibility settings
        let visibilityMap = {};
        try {
          const visibilityDoc = await db.collection('settings').doc('lesson_visibility').get();
          if (visibilityDoc.exists) visibilityMap = visibilityDoc.data();
        } catch (e) {
          console.error("Error fetching visibility:", e);
        }

        // Fetch Exam Results (Score based) for this student
        let examMap = {};
        try {
          const examsSnapshot = await db.collection('examResults')
            .where('studentEmail', '==', stdEmail)
            .get();
          examsSnapshot.forEach(doc => {
            const d = doc.data();
            if (d.testName) {
              const t = d.testName.trim();
              // Keep best score
              if (!examMap[t] || d.score > examMap[t].score) {
                examMap[t] = d;
              }
            }
          });
        } catch (e) { console.error("Error fetching exams in dashboard:", e); }

        let openLessons = 0;
        let completedOpenLessons = 0;

        // Load each unit from 3 to 4
        [3, 4].forEach(unitNum => {
          const unitLessons = CURRICULUM[stdGrade][unitNum];
          const card = document.getElementById(`unit${unitNum}Card`);
          const container = document.getElementById(`unit${unitNum}LessonsList`);

          if (unitLessons && unitLessons.length > 0) {
            card.style.display = 'block';
            container.innerHTML = '';

            unitLessons.forEach((lesson) => {
              const subActivities = ['-prep', '-task', 'mind', '-1'];
              let isCurrentComplete = true;

              subActivities.forEach(suffix => {
                const actId = lesson.id + suffix;

                // If it is a quiz (ending in -1), check Exam Score first
                if (suffix === '-1') {
                  const examData = examMap[actId];

                  if (examData) {
                    const max = examData.maxScore || 1;
                    const passing = max / 2;
                    if (examData.score < passing) {
                      isCurrentComplete = false;
                    }
                  } else {
                    isCurrentComplete = false;
                  }
                } else {
                  // Standard Time Logic for Prep, Task, Mind
                  const data = activityMap[actId];
                  const target = data?.targetTimeSeconds || 30;
                  const spent = data?.sessionTimeSeconds || 0;

                  if (!data || spent < target) {
                    isCurrentComplete = false;
                  }
                }
              });

              const isLocked = visibilityMap[lesson.id] !== true;

              if (!isLocked) {
                openLessons++;
                if (isCurrentComplete) completedOpenLessons++;
              }

              const lessonEl = document.createElement('div');
              lessonEl.className = `lesson-item ${isLocked ? 'locked' : ''}`;

              let statusIcon = isCurrentComplete ? 'âœ…' : 'âŒ';
              if (isLocked) statusIcon = 'ğŸ”’';

              const lessonContent = isLocked
                ? `<span class="lesson-name">${lesson.name}</span>`
                : `<a href="${lesson.path || '#'}" class="lesson-name" style="text-decoration: none; color: inherit; font-weight: 700; transition: color 0.2s;" onmouseover="this.style.color='#137fec'" onmouseout="this.style.color='inherit'">${lesson.name}</a>`;

              lessonEl.innerHTML = `
                <span class="status-badge">${statusIcon}</span>
                ${lessonContent}
              `;

              container.appendChild(lessonEl);
            });
          } else {
            card.style.display = 'none';
          }
        });

        // Update overall percentage based on OPEN lessons
        const percentage = openLessons > 0 ? Math.round((completedOpenLessons / openLessons) * 100) : 0;
        document.getElementById('completionPercentage').textContent = `${percentage}%`;

      } catch (error) {
        console.error("Error loading all units progress:", error);
      }
    }

    // document.addEventListener('DOMContentLoaded', loadAllUnitsProgress); removed

  </script>

  <script src="js/coins_manager.js"></script>
  <script src="js/user_profile.js"></script>
</body>

</html>