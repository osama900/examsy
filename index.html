<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</title>
  <link rel="stylesheet" href="css/style.css" />
  <script>
    if (!localStorage.getItem("std_id")) {
      alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
      window.location.href = "std_login.html";
    }
  </script>
  <style>
    .class-badge {
      position: absolute;
      top: 0;
      left: 0;
      background: #e3342f;
      color: #fff;
      font-size: 0.75rem;
      font-weight: bold;
      padding: 0.25rem 0.75rem;
      border-top-left-radius: 0.5rem;
      border-bottom-right-radius: 0.5rem;
    }



    /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† */
    #teacher-card {
      position: relative;
      background: #f6f7f8;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease-in-out;
    }

    #teacher-card:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
      transform: translateY(-4px);
    }



    #teacher-icon {
      width: 64px;
      height: 64px;
      fill: #137fec;
    }

    #teacher-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    #teacher-desc {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 1.5rem;
    }



    /* User Profile Styles */
    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: rgba(255, 255, 255, 0.9);
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .user-info-col {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      /* Align text to the right for RTL or relative to badge */
      line-height: 1.2;
    }

    .user-name {
      font-weight: 700;
      color: #333;
      font-size: 0.9rem;
    }

    .user-class {
      font-size: 0.75rem;
      color: #666;
      font-weight: bold;
      margin-top: 2px;
    }

    .user-initials-badge {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #137fec, #6fbafe);
      color: #fff;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 1rem;
      border: 2px solid #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    /* Dashboard Styles */
    .dashboard-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 20px;
    }

    .stat-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: 1.25rem;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      width: 56px;
      height: 56px;
      background: rgba(19, 127, 236, 0.1);
      border-radius: 0.75rem;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #137fec;
    }

    .stat-info {
      display: flex;
      flex-direction: column;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 800;
      color: #2c3e50;
      line-height: 1.2;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #7f8c8d;
      font-weight: 500;
    }

    /* Unit Progress Styles */
    .unit-progress-card {
      grid-column: 1 / -1;
      background: white;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      margin-top: 1rem;
    }

    .unit-progress-header {
      display: flex;
      flex-direction: row;
      /* Icon first, then text */
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f8f9fa;
      direction: rtl;
    }

    .unit-progress-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #2c3e50;
    }

    .lessons-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      direction: rtl;
      /* Lessons start from the right */
    }

    .lesson-item {
      display: flex;
      flex-direction: row;
      /* Flex order handles the RTL naturally with direction: rtl */
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: #ffffff;
      border-radius: 0.75rem;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      /* Slightly stronger shadow as requested */
      border: 1px solid #f1f3f5;
      direction: rtl;
    }

    .lesson-item:hover {
      background: #fdfdfd;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .lesson-name {
      font-size: 0.95rem;
      color: #34495e;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-grow: 1;
      text-align: right;
    }

    .lesson-item.locked {
      opacity: 0.6;
      background: #f1f3f5;
      cursor: not-allowed;
      pointer-events: none;
      box-shadow: none;
      border: 1px dashed #dee2e6;
    }

    .lesson-item.locked:hover {
      transform: none;
      box-shadow: none;
    }

    .lesson-item.locked .lesson-name {
      color: #95a5a6;
    }

    .lesson-item.locked .status-badge {
      filter: grayscale(1);
      opacity: 0.5;
    }

    .percentage-circle {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 1rem auto;
    }

    .percentage-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      font-weight: 800;
      color: #2c3e50;
    }

    .stat-card.progress-card {
      background: linear-gradient(135deg, #ffffff, #f0f7ff);
      border-right: 4px solid #3498db;
    }
  </style>
</head>

<body>
  <header class="main-header">
    <div class="header-content"
      style="display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1200px; margin: 0 auto;">
      <a href="index.html" class="logo-link">
        <span class="logo-emoji">ğŸ“š</span>
        <span class="logo-text">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</span>
      </a>
      <div id="user-profile-container"></div>
    </div>
  </header>

  <header class="hero">
    <h1>Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</h1>
    <p>Ù…Ø¯Ø±Ø³Ø© Ø²ÙŠØ¯ Ø¨Ù† Ø­Ø§Ø±Ø«Ø© Ø§Ù„Ø§Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø¨Ù†ÙŠÙ†</p>
  </header>

  <div class="dashboard-container">
    <div class="stat-cards-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ ÙˆÙ‚Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</span>
          <span class="stat-value" id="totalStudyTime">0:00</span>
        </div>
      </div>
      <div class="stat-card" style="border-right: 4px solid #f1c40f;">
        <div class="stat-icon" style="background: rgba(241, 196, 15, 0.1); color: #f1c40f;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
            <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
            <path d="M4 22h16"></path>
            <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
            <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
            <path d="M18 2H6v7a6 6 0 0 0 12 0V2z"></path>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-label">ØªØ±ØªÙŠØ¨Ùƒ Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø§Ø¨</span>
          <span class="stat-value" id="studentRank">--</span>
        </div>
      </div>
      <div class="stat-card progress-card">
        <div class="stat-icon" style="background: rgba(52, 152, 219, 0.1); color: #3498db;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <div class="stat-info">
          <span class="stat-value" id="completionPercentage">0%</span>
          <span class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙƒÙ„ÙŠØ©</span>
        </div>
      </div>

      <div class="unit-progress-card" id="unit3Card" style="display: none;">
        <div class="unit-progress-header">
          <div class="stat-icon"
            style="width: 40px; height: 40px; background: rgba(155, 89, 182, 0.1); color: #9b59b6;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
          </div>
          <span class="unit-progress-title">ØªÙ‚Ø¯Ù… Ø¯Ø±ÙˆØ³ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©</span>
        </div>
        <div class="lessons-list" id="unit3LessonsList"></div>
      </div>

      <div class="unit-progress-card" id="unit4Card" style="display: none;">
        <div class="unit-progress-header">
          <div class="stat-icon"
            style="width: 40px; height: 40px; background: rgba(230, 126, 34, 0.1); color: #e67e22;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
              <polyline points="2 17 12 22 22 17"></polyline>
              <polyline points="2 12 12 17 22 12"></polyline>
            </svg>
          </div>
          <span class="unit-progress-title">ØªÙ‚Ø¯Ù… Ø¯Ø±ÙˆØ³ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©</span>
        </div>
        <div class="lessons-list" id="unit4LessonsList"></div>
      </div>
    </div>
  </div>



  <div class="container">
    <h2 style="color: wheat; text-align: center; margin: 20px; font-size: 40px">
      Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
    </h2>
    <div class="cards">
      <a href="page/7th/7th.html">
        <div id="teacher-card">
          <div class="class-badge">7</div>

          <svg id="teacher-icon" viewBox="0 0 24 24">
            <path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 
                  3L1 9l11 6 9-4.91V17h2V9L12 3z"></path>
          </svg>
          <h4 id="teacher-title">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ</h4>
          <p id="teacher-desc">Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù‰ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ùˆ Ø§ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„</p>
        </div>
      </a>

      <a href="page/8th/8th.html">
        <div id="teacher-card">
          <div class="class-badge">8</div>

          <svg id="teacher-icon" viewBox="0 0 24 24">
            <path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 
                  3L1 9l11 6 9-4.91V17h2V9L12 3z"></path>
          </svg>
          <h4 id="teacher-title">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù…Ù† Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ</h4>
          <p id="teacher-desc">Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù‰ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ùˆ Ø§ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„</p>
        </div>
      </a>

      <a href="page/9th/9th.html">
        <div id="teacher-card">
          <div class="class-badge">9</div>

          <svg id="teacher-icon" viewBox="0 0 24 24">
            <path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 
                  3L1 9l11 6 9-4.91V17h2V9L12 3z"></path>
          </svg>
          <h4 id="teacher-title">Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹ Ø§Ù„Ø§Ø³Ø§Ø³ÙŠ</h4>
          <p id="teacher-desc">Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù‰ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ùˆ Ø§ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„</p>
        </div>
      </a>


    </div>
  </div>

  <footer>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© Teacher Osama Omar</footer>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    // Firebase Configuration (Same as others)
    const firebaseConfig = {
      apiKey: "AIzaSyAiJVhRbPOR0ty2Zaoyu4FQj9U4_rpnCf8",
      authDomain: "examsy-21dc3.firebaseapp.com",
      projectId: "examsy-21dc3",
      storageBucket: "examsy-21dc3.firebasestorage.app",
      messagingSenderId: "357464025229",
      appId: "1:357464025229:web:b920c8290f985f54339ac4",
      measurementId: "G-CWZ7MR4V26",
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    async function loadDashboardStats() {
      const stdId = localStorage.getItem('std_id');
      if (!stdId) return;

      try {
        const snapshot = await db.collection('std_id').doc(stdId).collection('study_activity').get();
        let totalSeconds = 0;

        snapshot.forEach(doc => {
          totalSeconds += doc.data().sessionTimeSeconds || 0;
        });

        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);

        // Format as H:MM
        const formattedTime = `${hours}:${minutes.toString().padStart(2, '0')}`;
        document.getElementById('totalStudyTime').textContent = formattedTime;

        // Update student's total time in Firestore for ranking
        await db.collection('std_id').doc(stdId).set({
          totalStudyTimeSeconds: totalSeconds,
          lastDashboardUpdate: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // Calculate Rank within the same Class and Grade
        const stdGrade = localStorage.getItem('std_grade');
        const stdClass = localStorage.getItem('std_class');

        const classSnapshot = await db.collection('std_id')
          .where('std_grade', '==', stdGrade)
          .where('std_class', '==', stdClass)
          .get();

        const studentsInClass = [];
        classSnapshot.forEach(doc => {
          const data = doc.data();
          studentsInClass.push({
            id: doc.id,
            time: data.totalStudyTimeSeconds || 0
          });
        });

        // Sort students by time (descending)
        studentsInClass.sort((a, b) => b.time - a.time);

        let rank = 0;
        const totalCompetitors = studentsInClass.length;

        for (let i = 0; i < studentsInClass.length; i++) {
          if (studentsInClass[i].id === stdId) {
            rank = i + 1;
            break;
          }
        }

        if (rank > 0) {
          const ordinals = {
            1: 'Ø§Ù„Ø£ÙˆÙ„', 2: 'Ø§Ù„Ø«Ø§Ù†ÙŠ', 3: 'Ø§Ù„Ø«Ø§Ù„Ø«', 4: 'Ø§Ù„Ø±Ø§Ø¨Ø¹', 5: 'Ø§Ù„Ø®Ø§Ù…Ø³',
            6: 'Ø§Ù„Ø³Ø§Ø¯Ø³', 7: 'Ø§Ù„Ø³Ø§Ø¨Ø¹', 8: 'Ø§Ù„Ø«Ø§Ù…Ù†', 9: 'Ø§Ù„ØªØ§Ø³Ø¹', 10: 'Ø§Ù„Ø¹Ø§Ø´Ø±'
          };
          const ordinalText = ordinals[rank] ? ` ( ${ordinals[rank]} )` : '';
          document.getElementById('studentRank').textContent = `${rank} / ${totalCompetitors}${ordinalText}`;
        }

      } catch (error) {
        console.error("Error loading dashboard stats:", error);
      }
    }

    document.addEventListener('DOMContentLoaded', loadDashboardStats);

    // Unit Progress Logic
    const CURRICULUM = {
      "7": {
        "2": [
          { id: "7-2-1", name: "Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„Ù‰ Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨" },
          { id: "7-2-2", name: "Ù…ÙƒÙˆÙ†Ø§Øª Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨" },
          { id: "7-2-3", name: "Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø±Ø¨Ø· ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ§Øª" },
          { id: "7-2-4", name: "Ø£Ù†ÙˆØ§Ø¹ Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ø­Ø§Ø³ÙˆØ¨" },
          { id: "7-2-5", name: "Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø¨ÙƒØ§Øª" },
          { id: "7-2-6", name: "Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ©" }
        ],
        "3": [
          { id: "7-3-1", name: "Ø§Ù„Ù…ÙˆØ§Ø·Ù†Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©" },
          { id: "7-3-2", name: "Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ø§Ù„ÙÙƒØ±ÙŠØ©" },
          { id: "7-3-3", name: "Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" },
          { id: "7-3-4", name: "Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªÙˆØ§Ø²Ù†" }
        ],
        "4": [
          { id: "7-4-1", name: "Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª" },
          { id: "7-4-2", name: "ØªØµÙ…ÙŠÙ… Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª" },
          { id: "7-4-3", name: "ØªÙ…Ø«ÙŠÙ„ Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª" }
        ]
      },
      "8": {
        "2": [
          { id: "8-2-1", name: "Ù…Ù‚Ø¯Ù…Ø© ÙÙŠ Ø³ÙƒØ±Ø§ØªØ´" },
          { id: "8-2-2", name: "Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØµÙ…ÙŠÙ…" },
          { id: "8-2-3", name: "Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©" },
          { id: "8-2-4", name: "Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª" },
          { id: "8-2-5", name: "Ù„Ø¨Ù†Ø§Øª Ø§Ù„ØªØ­ÙƒÙ…" }
        ]
      },
      "9": {
        "2": [
          { id: "9-2-1", name: "Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙÙŠ Ø³ÙƒØ±Ø§ØªØ´" },
          { id: "9-2-2", name: "Ø§Ù„Ø¬Ù…Ù„ Ø§Ù„Ø´Ø±Ø·ÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©" },
          { id: "9-2-3", name: "Ø­Ù„Ù‚Ø§Øª Ø§Ù„ØªÙƒØ±Ø§Ø±" },
          { id: "9-2-4", name: "Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©" }
        ],
        "3": [
          { id: "9-3-1", name: "Ø£Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Øª Ùˆ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª" },
          { id: "9-3-2", name: "ØªÙ‡Ø¯ÙŠØ¯Ø§Øª Ø§Ù„Ø§Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ" },
          { id: "9-3-3", name: "Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø§Ù…Ù† Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª" },
          { id: "9-3-4", name: "ÙˆØ³Ø§Ø¦Ù„ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" },
          { id: "9-3-5", name: "Ø§Ù„ØªØ´ÙÙŠØ±" }
        ],
        "4": [
          { id: "9-4-1", name: "Ù…Ù‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ" },
          { id: "9-4-2", name: "ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ" },
          { id: "9-4-3", name: "Ø§Ù„Ø±ÙˆØ¨ÙˆØª" },
          { id: "9-4-4", name: "Ø§Ø³Ø§Ø³ÙŠØ§Øª Ø¨Ø±Ù…Ø¬Ø© Ø±ÙˆØ¨ÙˆØª" }
        ]
      }
    };

    async function loadAllUnitsProgress() {
      const stdId = localStorage.getItem('std_id');
      const stdGrade = localStorage.getItem('std_grade');
      if (!stdId || !CURRICULUM[stdGrade]) return;

      try {
        // Fetch user activities
        const snapshot = await db.collection('std_id').doc(stdId).collection('study_activity').get();
        const activityMap = {};
        snapshot.forEach(doc => activityMap[doc.id] = doc.data());

        // Fetch global visibility settings
        let visibilityMap = {};
        try {
          const visibilityDoc = await db.collection('settings').doc('lesson_visibility').get();
          if (visibilityDoc.exists) visibilityMap = visibilityDoc.data();
        } catch (e) { console.error("Error fetching visibility:", e); }

        let openLessons = 0;
        let completedOpenLessons = 0;

        // Load each unit from 3 to 4
        [3, 4].forEach(unitNum => {
          const unitLessons = CURRICULUM[stdGrade][unitNum];
          const card = document.getElementById(`unit${unitNum}Card`);
          const container = document.getElementById(`unit${unitNum}LessonsList`);

          if (unitLessons && unitLessons.length > 0) {
            card.style.display = 'block';
            container.innerHTML = '';

            unitLessons.forEach((lesson) => {
              const subActivities = ['-prep', '-task', '-mind', '-1'];
              let isCurrentComplete = true;

              subActivities.forEach(suffix => {
                const actId = lesson.id + suffix;
                const data = activityMap[actId];
                const target = data?.targetTimeSeconds || 30;
                if (!data || (data.sessionTimeSeconds || 0) < target) {
                  isCurrentComplete = false;
                }
              });

              const isLocked = visibilityMap[lesson.id] !== true;

              if (!isLocked) {
                openLessons++;
                if (isCurrentComplete) completedOpenLessons++;
              }

              const lessonEl = document.createElement('div');
              lessonEl.className = `lesson-item ${isLocked ? 'locked' : ''}`;

              let statusIcon = isCurrentComplete ? 'âœ…' : 'âŒ';
              if (isLocked) statusIcon = 'ğŸ”’';

              lessonEl.innerHTML = `
                <span class="status-badge">${statusIcon}</span>
                <span class="lesson-name">${lesson.name}</span>
              `;

              container.appendChild(lessonEl);
            });
          } else {
            card.style.display = 'none';
          }
        });

        // Update overall percentage based on OPEN lessons
        const percentage = openLessons > 0 ? Math.round((completedOpenLessons / openLessons) * 100) : 0;
        document.getElementById('completionPercentage').textContent = `${percentage}%`;

      } catch (error) {
        console.error("Error loading all units progress:", error);
      }
    }

    document.addEventListener('DOMContentLoaded', loadAllUnitsProgress);
  </script>
  <script src="js/user_profile.js"></script>
</body>

</html>